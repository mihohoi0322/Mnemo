# 技術要件（ドラフト）

## 1. 全体方針
- 保存はローカル、解析はクラウドで実施。
- 検索は意味ベース（自然文）を主軸に、タグ検索を併用。
- iOSが主導線、将来Web閲覧を想定したデータ構造。

## 2. アーキテクチャ概要
- iOSアプリ
  - 画像取り込み、ローカル保存、メタデータ管理、検索UI。
- 解析サービス（クラウド）
  - OCR、画像内容理解、タグ生成、埋め込み生成。
- ローカル検索
  - 端末内インデックス（テキスト検索 + ベクトル検索）。

## 3. AI解析要件
- 入力
  - 画像（PNG/JPEG）。
- 出力（必須）
  - OCRテキスト。
  - 自動タグ（複数）。
  - タグ信頼度（0.0-1.0）。
- 出力（推奨）
  - 画像埋め込みベクトル（意味検索用）。
  - 主要オブジェクト/シーン候補。
- タグの編集
  - 自動タグと手動タグを区別して保存。
  - 手動タグは自動タグより優先。

## 4. 検索要件
- 自然文検索
  - クエリを埋め込みに変換し、ベクトル検索で候補抽出。
  - OCRテキストは補助的に利用。
- タグ検索
  - 完全一致および前方一致。
  - 手動タグを優先。
- ランキング
  - ベクトル類似度 + タグ一致度 + OCR一致度の合成スコア。

## 5. データ保存
- 画像
  - 端末ローカルに保存（ファイルシステム）。
- メタデータ
  - ローカルDB（例: SQLite）。
  - 画像ID、撮影日時、タグ（自動/手動）、OCR、埋め込み参照、解析状態、コレクション紐付け。
- インデックス
  - ベクトル検索用のローカルインデックス。

## 6. 処理フロー
1. 画像取り込み
2. ローカル保存 + メタデータ作成（解析待ち）
3. クラウド解析リクエスト送信
4. 解析結果受領
5. ローカルDB更新 + ベクトルインデックス更新
6. 検索・閲覧で利用

## 6.1 削除（完全削除）要件
- 削除は復元不可。
- UIは確認ダイアログ必須（「この操作は取り消せません」を明示）。
- 削除時のデータ整合性
  - 画像ファイルを削除。
  - ローカルDBの該当レコードを削除。
  - ベクトルインデックス/全文検索インデックスから該当エントリを削除。
  - 解析待ち/解析中のジョブがある場合はキャンセル、もしくは結果受領時に破棄（画像IDが存在しない場合は適用しない）。
- クラウド解析サービス側
  - 画像は永続化しない前提（処理後は破棄）。
  - 解析結果は端末に返すのみ（将来の同期を除く）。

## 7. 非機能要件（技術観点）
- 解析待ちのリトライ
  - オフライン時はキューに保持。
  - 自動再試行は最大3回（指数バックオフ: 30秒 / 2分 / 5分）。
  - 手動再試行は上限なし（ただし直近失敗後は10秒待機）。
- 通信
  - TLS必須。
- パフォーマンス
  - 1000枚程度で検索が1秒以内（暫定目標）。
- 拡張性
  - 将来Azure同期を前提に、ID体系はグローバル一意に。

## 8. 未決定項目
- 解析サービスの実装方式（自前/外部API）。
- ベクトルインデックスの実装（端末内ライブラリ選定）。
- OCR言語対応範囲（MVP: 日本語/英語）。
- コレクション設計の粒度（単一階層/ネスト/スマートコレクション）。
